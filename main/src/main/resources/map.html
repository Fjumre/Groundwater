<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>

    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            padding: 0;
            image-rendering: pixelated;
        }

        #info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 0 5px #999;
            z-index: 9999;
        }

        .colorbox {
            display:inline-block;
            width:18px;
            height:12px;
            margin-right:6px;
        }

        #groundCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 650;      /* BELOW the info box */
            pointer-events: none;
        }
    </style>

    <script>
        window.devicePixelRatio = 1;
        L_DISABLE_3D = true;
        L = { Browser: { retina: false } };
        L.DomUtil = L.DomUtil || {};
        L.DomUtil.TRANSFORM = '';
    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

</head>
<body>

<div id="map"></div>
<canvas id="groundCanvas"></canvas>

<div id="info">
    <b>Groundwater (kote)</b><br>
    <span class="colorbox" style="background:darkblue"></span> kote &lt; 0<br>
    <span class="colorbox" style="background:blue"></span> 0 – 5<br>
    <span class="colorbox" style="background:green"></span> 6 – 10<br>
    <span class="colorbox" style="background:orange"></span> 11 – 15<br>
    <span class="colorbox" style="background:red"></span> &gt; 15<br>
</div>

<script>
    L.Browser.retina = false;

    var map = L.map('map', {
        zoomSnap: 1,
        zoomDelta: 1
    }).setView([56.0, 10.0], 7);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
    }).addTo(map);

    //-----------------------------------
    // FAST CANVAS DATA STORAGE
    //-----------------------------------

    let groundwaterLines = [];     // ← All tiles stored here
    const canvas = document.getElementById("groundCanvas");
    const ctx = canvas.getContext("2d");


    //-----------------------------------
    // COLOR FUNCTION
    //-----------------------------------

    function colorForKote(kote) {
        if (kote < 0) return "darkblue";
        if (kote <= 5) return "blue";
        if (kote <= 10) return "green";
        if (kote <= 15) return "orange";
        return "red";
    }


    //-----------------------------------
    // REDRAW FUNCTION (CANVAS)
    //-----------------------------------

    function redrawGroundwater() {
        const size = map.getSize();
        canvas.width  = size.x;
        canvas.height = size.y;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const mapBounds = map.getBounds();
        const zoom = map.getZoom();

        groundwaterLines.forEach(obj => {
            const coords = obj.coords;
            const kote   = obj.kote;

            // --- optional bbox culling (if bbox is present) ---
            if (obj.bbox) {
                const [minLat, minLon, maxLat, maxLon] = obj.bbox;
                const lineBounds = L.latLngBounds(
                    [minLat, minLon],
                    [maxLat, maxLon]
                );
                if (!mapBounds.intersects(lineBounds)) {
                    return; // skip this line, not visible
                }
            }

            // Level-of-detail: skip points when zoomed out
            let step = 1;
            if (zoom <= 7)      step = 8;
            else if (zoom <= 9) step = 4;
            else if (zoom <= 11)step = 2;
            // zoom > 11 → full detail

            if (coords.length === 0) return;

            ctx.strokeStyle = colorForKote(kote);
            ctx.lineWidth = 2;
            ctx.beginPath();

            for (let i = 0; i < coords.length; i += step) {
                const latlon = coords[i]; // [lat, lon]
                const p = map.latLngToContainerPoint(latlon);

                if (i === 0) ctx.moveTo(p.x, p.y);
                else         ctx.lineTo(p.x, p.y);
            }

            ctx.stroke();
        });
    }


    //-----------------------------------
    // Called by Java: load JSON tile
    //-----------------------------------

    function loadTile(tileBatchJson) {
        groundwaterLines.push(...tileBatchJson);
        scheduleRedraw();
    }

    //-----------------------------------
    // Redraw on zoom / pan (throttled)
    //-----------------------------------

    let redrawScheduled = false;

    function scheduleRedraw() {
        if (redrawScheduled) return;
        redrawScheduled = true;
        requestAnimationFrame(() => {
            redrawScheduled = false;
            redrawGroundwater();
        });
    }

    window.addEventListener("resize", scheduleRedraw);
    map.on("zoom",  scheduleRedraw);
    map.on("move",  scheduleRedraw);
</script>

</body>
</html>
